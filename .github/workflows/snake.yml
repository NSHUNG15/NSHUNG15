name: 🐍 Generate Snake Game & Update Profile

on:
  # Runs on every push to main branch
  push:
    branches: [ main, master ]
  
  # Runs on schedule - every 12 hours
  schedule:
    - cron: "0 */12 * * *"
  
  # Allows manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-snake:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      # Checkout repository
      - name: 🛒 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      # Generate snake animation
      - name: 🐍 Generate snake game from GitHub contributions
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: NSHUNG15
          outputs: |
            github-contribution-grid-snake.svg
            github-contribution-grid-snake-dark.svg?palette=github-dark
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      # Create daily snack commit
      - name: 🍿 Daily snack commit
        run: |
          # Create daily snacks file if it doesn't exist
          if [ ! -f daily-snacks.md ]; then
            echo "# 🍿 Daily Snacks - Keeping the streak alive!" > daily-snacks.md
            echo "" >> daily-snacks.md
          fi
          
          # Add today's snack
          echo "- 🍿 $(date '+%Y-%m-%d %H:%M:%S') - Daily snack commit!" >> daily-snacks.md
          
          # Keep only last 30 entries
          tail -n 31 daily-snacks.md > temp-snacks.md
          mv temp-snacks.md daily-snacks.md
          
      # Commit and push all changes
      - name: 🚀 Commit and push changes
        run: |
          git config --local user.email "nshung0105@gmail.com"
          git config --local user.name "Nguyễn Sinh Hùng"
          git add .
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "🐍 Update snake game and daily snack [automated] $(date '+%Y-%m-%d')"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-readme:
    runs-on: ubuntu-latest
    needs: generate-snake
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: 🛒 Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
        
      # Update README timestamp
      - name: 📊 Update README stats
        run: |
          # Create a simple stats update
          echo "Last updated: $(date '+%Y-%m-%d %H:%M:%S')" > last-update.txt
          
      # Commit README updates
      - name: 🔄 Commit README updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add .
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "📊 Update profile stats [automated]"
            git push
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}